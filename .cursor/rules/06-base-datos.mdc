---
globs: src/server/db/**/*.ts
alwaysApply: false
---
# Convenciones de base de datos

## üóÑÔ∏è Reglas obligatorias

### 1. Doble ID (CR√çTICO para seguridad)

```typescript
// ‚ùå MAL - Solo un ID
id: bigserial('id', { mode: 'number' }).primaryKey()

// ‚úÖ BIEN - Doble ID
id: bigserial('id', { mode: 'number' }).primaryKey(), // Uso interno
idPublico: uuid('id_publico').notNull().defaultRandom().unique(), // Para API/Frontend
```

**¬øPor qu√© doble ID?**
- `id` (n√∫mero): R√°pido para la base de datos, pero predecible
- `idPublico` (UUID): Seguro para exponer en URLs y APIs, imposible de adivinar, previene enumeraci√≥n, oculta volumen de datos

### 2. Campos obligatorios en TODAS las tablas

  - id (BIGSERIAL PRIMARY KEY)
  - id_publico (UUID UNIQUE con √≠ndice)
  - fecha_creacion (TIMESTAMPTZ)
  - fecha_actualizacion (TIMESTAMPTZ)
  - activo (BOOLEAN, para soft delete)
  - adicional (JSONB)

### 3. Nombres en espa√±ol, snake_case

```typescript
// ‚úÖ BIEN
fecha_creacion, nombre_completo, correo_electronico

// ‚ùå MAL
createdAt, fullName, email
```

**Convenci√≥n de nombres:**
- Tablas: `usuarios`, `productos`, `ordenes`
- Columnas: `nombre_completo`, `fecha_nacimiento`, `correo_electronico`
- Todo en min√∫sculas con guiones bajos

### 4. Esquemas de base de datos

Usar esquemas para organizar tablas:

- `app` - Tablas principales de la aplicaci√≥n
- `audit` - Logs y auditor√≠a
- `scraping` - Datos temporales o externos

> **NUNCA usar el esquema public**

Definir el schema con `pgSchema` y crear las tablas usando `appSchema.table`:

```typescript
import { pgSchema } from 'drizzle-orm/pg-core';

const appSchema = pgSchema('app');

export const usuarios = appSchema.table('usuarios', {
  // campos...
}, (table) => ({
  // √≠ndices y constraints
}));

// Se guarda en: src/server/db/schema/app/usuarios.ts
```

## üîí Borrado l√≥gico (soft delete)

**NUNCA borres registros f√≠sicamente.** Usa el campo `activo`:

```typescript
// ‚ùå MAL - Borrado f√≠sico
await db.delete(usuarios).where(eq(usuarios.id, userId));

// ‚úÖ BIEN - Borrado l√≥gico
await db.update(usuarios)
  .set({ activo: false })
  .where(eq(usuarios.id, userId));
```

## üìù Ejemplo Completo

```typescript
import { pgSchema, bigserial, uuid, varchar, timestamp, boolean, jsonb } from 'drizzle-orm/pg-core';

const appSchema = pgSchema('app');

export const productos = appSchema.table('productos', {
  // IDs obligatorios
  id: bigserial('id', { mode: 'number' }).primaryKey(),
  idPublico: uuid('id_publico').notNull().defaultRandom().unique(),
  
  // Campos de negocio
  nombre: varchar('nombre', { length: 255 }).notNull(),
  descripcion: varchar('descripcion', { length: 1000 }),
  precio: numeric('precio', { precision: 10, scale: 2 }).notNull(),
  
  // Campos de control obligatorios
  fechaCreacion: timestamp('fecha_creacion', { withTimezone: true }).notNull().defaultNow(),
  fechaActualizacion: timestamp('fecha_actualizacion', { withTimezone: true }).notNull().defaultNow(),
  activo: boolean('activo').notNull().default(true),
  adicional: jsonb('adicional').$type<Record<string, any>>(),
});
```
